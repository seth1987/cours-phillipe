#!/bin/bash

# Script d'audit s√©curit√© automatis√©
# Usage: bash scripts/security-scan.sh

echo "=================================="
echo "üîí AUDIT DE S√âCURIT√â"
echo "=================================="
echo ""

# Couleurs
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

ERRORS=0
WARNINGS=0

# Fonction d'affichage
error() {
  echo -e "${RED}‚ùå ERREUR:${NC} $1"
  ((ERRORS++))
}

warning() {
  echo -e "${YELLOW}‚ö†Ô∏è  WARNING:${NC} $1"
  ((WARNINGS++))
}

success() {
  echo -e "${GREEN}‚úÖ OK:${NC} $1"
}

# ================================
# 1. V√âRIFICATION FICHIERS SECRETS
# ================================
echo "üìÅ 1. V√©rification fichiers secrets..."

if git ls-files | grep -qE "\.env\.local|\.env\.production|\.pem$|\.key$"; then
  error "Fichiers secrets d√©tect√©s dans Git:"
  git ls-files | grep -E "\.env\.local|\.env\.production|\.pem$|\.key$"
else
  success "Aucun fichier secret track√© dans Git"
fi

if [ -f .env.local ] && [ ! -f .env.example ]; then
  warning ".env.local existe mais pas de .env.example"
fi

echo ""

# ================================
# 2. CONSOLE.LOG EN PRODUCTION
# ================================
echo "üìã 2. Recherche console.log dans le code..."

CONSOLE_LOGS=$(grep -r "console\.log" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules src/ | wc -l)

if [ "$CONSOLE_LOGS" -gt 0 ]; then
  warning "Trouv√© $CONSOLE_LOGS console.log dans src/"
  echo "Fichiers concern√©s:"
  grep -r "console\.log" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules src/ -l | head -5
  echo "  ... (utilisez 'grep -r console.log src/' pour voir tous)"
else
  success "Aucun console.log trouv√©"
fi

echo ""

# ================================
# 3. SECRETS HARDCOD√âS
# ================================
echo "üîë 3. Recherche secrets hardcod√©s..."

SECRETS_PATTERNS=(
  "API_KEY.*=.*['\"]"
  "SECRET.*=.*['\"]"
  "PASSWORD.*=.*['\"]"
  "TOKEN.*=.*['\"]"
)

for pattern in "${SECRETS_PATTERNS[@]}"; do
  FOUND=$(grep -rE "$pattern" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules src/ 2>/dev/null | wc -l)
  if [ "$FOUND" -gt 0 ]; then
    error "Pattern suspect trouv√©: $pattern ($FOUND occurrences)"
  fi
done

# V√©rifier process.env sans NEXT_PUBLIC
ENV_USAGES=$(grep -r "process\.env\." --include="*.ts" --include="*.tsx" --exclude-dir=node_modules src/ | grep -v "NEXT_PUBLIC" | wc -l)
if [ "$ENV_USAGES" -gt 10 ]; then
  warning "$ENV_USAGES usages de process.env sans NEXT_PUBLIC (v√©rifier si appropri√©)"
fi

success "Scan secrets hardcod√©s termin√©"
echo ""

# ================================
# 4. VALIDATION ZOD
# ================================
echo "‚úÖ 4. V√©rification validations Zod..."

if [ ! -f "src/lib/validation/schemas.ts" ]; then
  error "Fichier src/lib/validation/schemas.ts introuvable"
else
  success "Fichier de sch√©mas Zod trouv√©"
fi

# V√©rifier que les Server Actions utilisent bien .safeParse
ACTIONS_WITHOUT_VALIDATE=$(grep -l "export async function" src/actions/*.ts | while read file; do
  if ! grep -q "\.safeParse\|\.parse" "$file"; then
    echo "$file"
  fi
done)

if [ -n "$ACTIONS_WITHOUT_VALIDATE" ]; then
  warning "Server Actions sans validation Zod:"
  echo "$ACTIONS_WITHOUT_VALIDATE"
fi

echo ""

# ================================
# 5. RLS SUPABASE
# ================================
echo "üõ°Ô∏è  5. V√©rification policies RLS..."

RLS_FILE="supabase/migrations/002_rls_policies.sql"
if [ ! -f "$RLS_FILE" ]; then
  error "Fichier RLS policies introuvable: $RLS_FILE"
else
  TABLES_WITH_RLS=$(grep -c "ENABLE ROW LEVEL SECURITY" "$RLS_FILE")
  POLICIES_COUNT=$(grep -c "CREATE POLICY" "$RLS_FILE")

  success "$TABLES_WITH_RLS tables avec RLS activ√©"
  success "$POLICIES_COUNT policies d√©finies"

  # V√©rifier que toutes les tables ont au moins une policy
  TABLES=(profiles rdm_types exercises exercise_instances attempts)
  for table in "${TABLES[@]}"; do
    if ! grep -q "CREATE POLICY.*ON $table" "$RLS_FILE"; then
      error "Aucune policy trouv√©e pour la table: $table"
    fi
  done
fi

echo ""

# ================================
# 6. D√âPENDANCES VULN√âRABLES
# ================================
echo "üì¶ 6. Scan vuln√©rabilit√©s npm..."

if command -v npm &> /dev/null; then
  npm audit --json > /tmp/npm-audit.json 2>/dev/null

  CRITICAL=$(cat /tmp/npm-audit.json | grep -o '"critical":[0-9]*' | grep -o '[0-9]*' | head -1)
  HIGH=$(cat /tmp/npm-audit.json | grep -o '"high":[0-9]*' | grep -o '[0-9]*' | head -1)

  if [ -n "$CRITICAL" ] && [ "$CRITICAL" -gt 0 ]; then
    error "$CRITICAL vuln√©rabilit√©s critiques d√©tect√©es (npm audit)"
  fi

  if [ -n "$HIGH" ] && [ "$HIGH" -gt 0 ]; then
    warning "$HIGH vuln√©rabilit√©s haute s√©v√©rit√© d√©tect√©es"
  fi

  if [ -z "$CRITICAL" ] || [ "$CRITICAL" -eq 0 ]; then
    success "Aucune vuln√©rabilit√© critique npm"
  fi

  rm -f /tmp/npm-audit.json
else
  warning "npm non install√©, skip audit"
fi

echo ""

# ================================
# 7. FICHIERS SENSIBLES
# ================================
echo "üîç 7. Recherche fichiers sensibles..."

SENSITIVE_FILES=(
  "*.pem"
  "*.key"
  "*.p12"
  "*.pfx"
  "credentials.json"
  "serviceAccount.json"
)

for pattern in "${SENSITIVE_FILES[@]}"; do
  FOUND=$(find . -name "$pattern" -not -path "*/node_modules/*" 2>/dev/null)
  if [ -n "$FOUND" ]; then
    warning "Fichier sensible trouv√©: $FOUND"
  fi
done

success "Scan fichiers sensibles termin√©"
echo ""

# ================================
# 8. TYPESCRIPT STRICT MODE
# ================================
echo "üìù 8. V√©rification TypeScript strict mode..."

if [ -f "tsconfig.json" ]; then
  if grep -q '"strict": true' tsconfig.json; then
    success "TypeScript strict mode activ√©"
  else
    warning "TypeScript strict mode d√©sactiv√©"
  fi

  if grep -q '"noImplicitAny": false' tsconfig.json; then
    error "noImplicitAny d√©sactiv√© (risque de type 'any' non d√©tect√©)"
  fi
else
  error "tsconfig.json introuvable"
fi

echo ""

# ================================
# 9. MIDDLEWARE S√âCURIT√â
# ================================
echo "üö¶ 9. V√©rification middleware..."

MIDDLEWARE_FILE="src/middleware.ts"
if [ ! -f "$MIDDLEWARE_FILE" ]; then
  error "Fichier middleware introuvable: $MIDDLEWARE_FILE"
else
  success "Middleware trouv√©"

  if ! grep -q "auth.getUser" "$MIDDLEWARE_FILE" && ! grep -q "updateSession" "$MIDDLEWARE_FILE"; then
    warning "Middleware ne semble pas v√©rifier l'authentification"
  fi

  if ! grep -q "redirect" "$MIDDLEWARE_FILE"; then
    warning "Middleware ne fait pas de redirections (routes non prot√©g√©es?)"
  fi
fi

echo ""

# ================================
# 10. GITIGNORE
# ================================
echo "üö´ 10. V√©rification .gitignore..."

GITIGNORE_REQUIRED=(
  ".env*.local"
  "node_modules"
  ".next"
  "*.pem"
  "*.key"
)

for pattern in "${GITIGNORE_REQUIRED[@]}"; do
  if ! grep -q "$pattern" .gitignore 2>/dev/null; then
    error "$pattern manquant dans .gitignore"
  fi
done

success "V√©rification .gitignore termin√©e"
echo ""

# ================================
# R√âSUM√â
# ================================
echo "=================================="
echo "üìä R√âSUM√â"
echo "=================================="
echo -e "${RED}Erreurs: $ERRORS${NC}"
echo -e "${YELLOW}Warnings: $WARNINGS${NC}"

if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
  echo -e "${GREEN}üéâ Aucun probl√®me de s√©curit√© d√©tect√©!${NC}"
  exit 0
elif [ $ERRORS -eq 0 ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  Quelques warnings √† v√©rifier${NC}"
  exit 0
else
  echo -e "${RED}üî¥ Des erreurs critiques ont √©t√© d√©tect√©es!${NC}"
  exit 1
fi
